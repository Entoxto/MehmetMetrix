# Mehmet Metrics

Внутренняя панель управления для отслеживания заказов на пошив изделий из кожи, меха и экзотических материалов. Приложение позволяет контролировать поставки, видеть финансовые показатели и просматривать каталог продукции.

## 🎯 Назначение

Приложение решает три основные задачи:

1. **Контроль производства** — отслеживание поставок изделий на разных этапах: в производстве, в пути, получено (с группировкой по годам)
2. **Финансовый учёт** — расчёт сумм к оплате за поставки и учёт депозитов
3. **Каталог продукции** — просмотр изделий с ценами, размерами и материалами

---

## 🚀 Запуск

```bash
# Установка зависимостей
npm install

# Режим разработки
npm run dev

# Сборка для продакшена
npm run build

# Запуск продакшен-сервера
npm start
```

Приложение откроется на `http://localhost:3000`

---

## 📁 Структура проекта

```
├── app/                    # Next.js App Router — страницы
│   ├── page.tsx            # Главная — меню навигации
│   ├── work/page.tsx       # Раздел «Работа» — поставки и статусы (с группировкой по годам)
│   ├── money/page.tsx      # Раздел «Деньги» — суммы к оплате
│   ├── catalog/page.tsx    # Каталог изделий
│   ├── product/[id]/       # Детальная страница товара
│   ├── layout.tsx          # Корневой layout с провайдерами
│   └── home/               # Компоненты главной страницы
│       ├── Menu.tsx        # Карточки навигации
│       ├── Work.tsx        # UI раздела «Работа»
│       ├── Money.tsx       # UI раздела «Деньги»
│       ├── Catalog.tsx     # UI каталога
│       ├── UpSector.tsx    # Шапка страницы
│       ├── DownSector.tsx  # Подвал страницы
│       └── styles.ts       # Стили для layout
│
├── components/             # Переиспользуемые компоненты
│   ├── Shell.tsx           # Общая обёртка страниц (шапка + контент + подвал)
│   ├── ProductCard.tsx     # Карточка товара в каталоге
│   ├── ProductDetail.tsx   # Детальный просмотр товара
│   ├── CategoryCard.tsx    # Карточка категории
│   ├── providers/
│   │   └── BreakpointProvider.tsx  # Контекст для адаптивности
│   ├── work/
│   │   ├── YearGroup.tsx   # Группа поставок по году (выпадающий список)
│   │   ├── BatchView.tsx   # Таблица поставки с группировкой по статусам
│   │   └── PositionRow.tsx # Строка позиции в таблице
│   └── ui/
│       ├── SizeChips.tsx   # Чипы размеров (XS, S, M...)
│       ├── SampleTag.tsx   # Метка «образец»
│       └── StatusBadge.tsx # Бейдж статуса
│
├── data/                   # JSON-данные
│   ├── products.json       # Каталог изделий (цены обновляются из поставок)
│   ├── shipments.json      # Поставки и позиции с историческими ценами
│   └── money.json          # Депозиты и предоплаты
│
├── scripts/                # Скрипты оптимизации изображений
│   └── convert_to_webp.py  # Конвертация JPG → WebP (пропускает уже существующие)
│
├── Excel/                  # Парсер Excel → JSON
│   ├── parse_excel.py      # Главный скрипт парсинга Excel
│   ├── excel_parser.py      # Основной парсер Excel файла
│   ├── utils.py            # Вспомогательные функции парсинга
│   ├── update_prices.py    # Скрипт обновления цен в каталоге
│   ├── логика парсинга.txt # Документация логики парсинга
│   └── _tmp_read_excel.py  # Утилита для просмотра Excel (вспомогательная)
│
├── public/                 # Статические файлы
│   └── images/
│       └── products/
│           ├── jpg/        # Оригинальные JPG изображения
│           └── webp/       # Оптимизированные WebP изображения
│
├── types/                  # TypeScript типы
│   ├── domain.ts           # Доменная модель: Position, Batch
│   ├── product.ts          # Тип Product для каталога
│   └── shipment.ts         # Типы для поставок: ShipmentRawItem, ShipmentConfig, ShipmentWithItems
│
├── lib/                    # Бизнес-логика
│   ├── adapters.ts         # Преобразование JSON → доменная модель
│   ├── shipments.ts        # buildShipments() — сборка поставок, группировка по годам (типы из types/shipment.ts)
│   ├── prices.ts           # Работа с ценами из поставок
│   ├── derive.ts           # Группировка позиций по статусам
│   ├── format.ts           # Форматирование: валюта, иконки статусов
│   ├── utils.ts            # UI-утилиты: hover-эффекты
│   ├── breakpoints.ts      # Пороги адаптивности (mobile/tablet/desktop)
│   └── imageUtils.ts       # Утилиты для оптимизации изображений (WebP, JPG fallback, blur placeholder)
│
├── hooks/                  # React-хуки
│   └── useBreakpoint.ts    # Определение текущего брейкпоинта
│
├── constants/              # Константы
│   ├── styles.ts           # Цвета, отступы, типографика
│   └── MonitorSize.ts      # Реэкспорт useBreakpoint
│
└── contexts/
    └── BreakpointContext.tsx  # Контекст для размера экрана
```

---

## 🏗 Архитектура

### Потоки данных

```
┌─────────────────────────────────────────────────────────────────┐
│                         JSON-файлы                              │
│  products.json    shipments.json    money.json                  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    lib/adapters.ts                              │
│  toPosition() — преобразует сырой item в Position               │
│  toBatch() — собирает Batch из позиций                          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                   lib/shipments.ts                              │
│  buildShipments() — создаёт ShipmentWithItems[]                 │
│  getShipmentYear() — определяет год поставки                   │
│  groupShipmentsByYear() — группирует поставки по годам         │
│  Считает totalAmount, определяет hasPriceGaps                   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Страницы (app/)                            │
│  WorkPage, MoneyPage — используют buildShipments()              │
│  CatalogPage — напрямую читает products.json                    │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Компоненты UI                                │
│  Work.tsx → YearGroup → BatchView → PositionRow                │
│  Money.tsx — карточки с суммами                                 │
│  Catalog.tsx → ProductCard → ProductDetail                      │
└─────────────────────────────────────────────────────────────────┘
```

### Доменная модель

**Position** — единица изделия в поставке:
```typescript
interface Position {
  id: string;
  productId: string;       // Ссылка на товар в каталоге
  title: string;           // Название позиции
  sizes: Record<Size, number>;  // Количество по размерам
  qty: number;             // Общее количество
  price: number | null;    // Цена за единицу в долларах (из колонки H Excel)
  cost: number | null;     // Себестоимость в рублях (из колонки N Excel)
  sum: number | null;      // Сумма к оплате (price × qty) или null
  sample: boolean;         // Это образец?
  statusLabel: string;     // Текстовый статус (1 в 1 из Excel)
  noteEnabled: boolean;    // Показывать примечание?
  noteText: string | null; // Текст примечания
}
```

**Статусы позиций** — произвольные строки из Excel (выпадающий список):
- `Получено, оплачено ✅`
- `Получено, не оплачено 📦`
- `В производстве 🛠️`
- `Готово, ожидает отправки 🕒`
- `В пути 🚚`

> **Примечание:** Статусы прокидываются из Excel как есть (1 в 1). Логика «оплачен / не оплачен» определяется функцией `isPaidStatus()` в `lib/statusText.ts` — она проверяет наличие слова «оплачен» в тексте статуса. Благодаря выпадающим спискам (Data Validation) в Excel, риск опечатки исключен на уровне источника данных.

**Batch** — поставка изделий (в коде также используется термин "shipment"):
```typescript
interface Batch {
  id: string;
  receivedAt?: string;     // Дата получения
  positions: Position[];   // Позиции партии
}
```

### Архитектура цен

**Цены хранятся в поставках**, а не в каталоге. Это позволяет:
- Сохранять историческую правду (поставка 1 = $100, поставка 2 = $110)
- Автоматически обновлять каталог — берётся цена из последней поставки

**Обновление цен и себестоимости в каталоге:**
- Цены и себестоимость в `products.json` обновляются автоматически из `shipments.json`
- Скрипт `Excel/update_prices.py` проходит по поставкам от новых к старым
- Для каждого товара записывается самая актуальная цена (в долларах) и себестоимость (в рублях) из последней поставки
- Скрипт `Excel/parse_excel.py` автоматически запускает `update_prices.py` после парсинга
- Приложение использует цены и себестоимость напрямую из `products.json` (без дополнительной обработки)

```
┌─────────────────────────────────────────────────────────┐
│                    shipments.json                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐               │
│  │Поставка 10│  │Поставка 11│  │Поставка 12│  ← хронология│
│  │price:100│  │price:110│  │price:115│                  │
│  └──────────┘  └──────────┘  └──────────┘               │
└─────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    update_prices.py обновляет
                                    │
                                    ▼
                          products.json
                          price: $115
                                    │
                                    ▼
                          Приложение использует
                          product.price напрямую
```

### Расчёт сумм

**Сумма позиции** вычисляется в `lib/adapters.ts`:
```typescript
// Цена берётся из поставки (историческая правда)
const price = typeof item.price === 'number' ? item.price : null;

// Сумма = цена × количество, но только если:
// - Цена известна (price != null)
// - Позиция не оплачена ранее (paidPreviously = false)
// - Позиция требует оплаты (noPayment = false)
const sum = price != null && !paidPreviously && !noPayment
  ? price * qty
  : null;
```

**Сумма поставки** — сумма всех `position.sum` где `sum !== null`.

**Итого к оплате** (`app/money/page.tsx`):
- Берутся поставки, где статус НЕ содержит слово "оплач" (кроме "не оплачено")
- Суммируются `pendingAmount` по поставкам
- Поиск подстроки "оплач" безопасен благодаря Data Validation в Excel (статусы выбираются из выпадающего списка)

### Группировка по годам

**Раздел «Работа»** (`app/work/page.tsx`) отображает поставки, сгруппированные по годам:

- По умолчанию открыт текущий год (2025)
- Годы отсортированы по убыванию (новые сверху)
- Год определяется автоматически из `receivedDate` или явно через поле `year`
- Внутри года поставки отображаются без отступов, не уменьшая ширину экрана

**Функции в `lib/shipments.ts`:**
- `getShipmentYear(shipment)` — определяет год поставки (приоритет: явный `year` → `receivedDate` → текущий год)
- `groupShipmentsByYear(shipments)` — группирует поставки по годам, возвращает отсортированный `Map<year, shipments[]>`

### Структура таблицы поставки

**Таблица в `BatchView.tsx`** отображает следующие колонки:

| Колонка | Описание | Валюта | Видимость на мобильных |
|---------|----------|--------|------------------------|
| Позиция | Название товара | — | ✅ Видна |
| Кол-во | Количество единиц | — | ✅ Видна |
| Цена | Цена за единицу | $ (доллары) | ✅ Видна |
| Сумма | Итоговая сумма (цена × количество) | $ (доллары) | ✅ Видна |
| Себестоимость | Себестоимость с учётом карго за единицу (из колонки N Excel) | ₽ (рубли, округляется до целых) | ❌ Скрыта (прокрутка) |

**Мобильная адаптация:**
- На мобильных устройствах (< 768px) колонка "Себестоимость" скрыта для экономии места
- Таблица поддерживает горизонтальную прокрутку для доступа к скрытой колонке
- Видимые колонки (Позиция, Кол-во, Цена, Сумма) занимают 100% ширины экрана
- Скрытая колонка "Себестоимость" доступна при горизонтальной прокрутке справа

### Сортировка в каталоге

**Раздел «Каталог»** (`app/catalog/page.tsx`) автоматически сортирует товары:

- Товары внутри каждой категории отображаются в алфавитном порядке по названию
- Сортировка учитывает русскую локаль для корректного порядка букв
- Сортировка применяется только к товарам, которые есть в наличии (`inStock: true`)

---

## 📱 Адаптивность

Приложение адаптируется под 4 брейкпоинта:

| Брейкпоинт | Ширина | Использование |
|------------|--------|---------------|
| `mobile` | < 768px | Компактные карточки, таблица с горизонтальной прокруткой |
| `tablet` | 768–1024px | Средний размер элементов |
| `laptop` | 1024–1280px | Десктопный layout |
| `desktop` | ≥ 1280px | Полноразмерный интерфейс |

**Как работает:**
1. На сервере `layout.tsx` определяет начальный брейкпоинт по User-Agent
2. `BreakpointProvider` оборачивает приложение и отслеживает `window.resize`
3. Компоненты используют хук `useBreakpoint()` для получения текущего размера

```typescript
const { isMobile, isDesktop, breakpoint } = useBreakpoint();
```

---

## 📊 Импорт данных из Excel

Приложение поддерживает автоматический импорт поставок из Excel файла.

### Парсинг Excel → JSON

**Требования:**
- Python 3.x
- Установленные зависимости: `pandas`, `openpyxl`

**Запуск парсинга:**
```bash
cd Excel
python parse_excel.py
```

Скрипт:
1. Читает файл `Расчёты с мехметом new.xlsx` (лист "Поставки")
2. Парсит поставки, позиции, статусы, цены и даты
3. Извлекает `price` из колонки H ("Стоймость 1 ед $") — цена в долларах
4. Извлекает `cost` из колонки N ("Себестоимость с учётом карго") — себестоимость в рублях
5. Сохраняет результат в `data/shipments.json`

**Обновление цен в каталоге:**
```bash
cd Excel
python update_prices.py
```

Скрипт:
1. Читает `data/shipments.json` (поставки отсортированы от новых к старым)
2. Проходит по всем позициям и находит самую актуальную цену для каждого товара
3. Обновляет поле `price` в `data/products.json`

**Документация:**
- Подробная логика парсинга описана в `Excel/логика парсинга.txt`
- Парсер автоматически определяет год поставки по разделителям в Excel
- Нормализует пробелы в названиях для корректного маппинга с каталогом

### Безопасность ввода данных

**Data Validation в Excel:**

В исходном Excel-файле (`Расчёты с мехметом new.xlsx`) используется **Data Validation (выпадающие списки)** для полей "Статус позиций" и "Статус поставок". Это означает, что пользователь может выбрать статус только из предопределённого списка, а не ввести произвольный текст.

**Почему это важно:**

1. **Исключение человеческого фактора:** Риск опечатки (человеческого фактора) исключен на уровне Excel. Пользователь физически не может ввести неверный статус.

2. **Безопасность строкового поиска:** Это объясняет, почему мы можем полагаться на строковый поиск (`includes("оплачен")`) в коде. Поскольку все статусы строго регламентированы через выпадающие списки, поиск подстроки является безопасным и предсказуемым.

3. **Прозрачный парсинг:** Статусы из Excel прокидываются в JSON как есть (без маппинга). Логика «оплачен / не оплачен» определяется на стороне TypeScript функцией `isPaidStatus()`.

**Пример использования в коде:**

```typescript
// app/money/page.tsx
import { isPaidStatus } from '@/lib/statusText';

// Фильтрация по тексту статуса — безопасна благодаря выпадающим спискам Excel
const isMarkedPaid = isPaidStatus(shipment.status);
```

**Вывод:** Благодаря выпадающим спискам в Excel, маппинг статусов является жестким и безопасным. Фильтрация в разделе "Деньги" по слову "оплач" также опирается на строго регламентированные значения из Excel, что исключает риск опечаток на уровне источника данных.

---

## 📝 Добавление данных

### Новый товар в каталог

Добавьте объект в `data/products.json`:
```json
{
  "id": "unique-id",
  "name": "Название изделия — вариант",
  "category": "Экзотика",
  "photo": "/images/products/jpg/Название изделия — вариант.jpg",
  "sizes": ["xs", "s"],
  "materials": {
    "outer": "Натуральная кожа питона",
    "lining": "70% Acetate 30% Polyester",
    "comments": "Описание материала"
  },
  "inStock": true,
  "tags": ["эксклюзив", "премиум"]
}
```

> **Примечание:** Цена и себестоимость НЕ указываются в каталоге — они берутся из поставок автоматически.

### Формат наименований

Все названия следуют формату: **`Изделие из материала — вариант`**

Примеры:
- `Жакет приталенный из кожи питона — чёрный глянцевый`
- `Брюки из замши — коричневый`
- `Дублёнка из мериноса — бежевый`

### Новая позиция в поставку

Добавьте объект в `rawItems` нужной поставки в `data/shipments.json`:
```json
{
  "productId": "unique-id",
  "overrideName": "Название для отображения",
  "price": 320,
  "sizes": { "xs": 5, "s": 3 },
  "status": "in_progress"
}
```

**Обязательные поля:**
- `productId` — ссылка на товар в каталоге
- `price` — цена на момент поставки в долларах (историческая, из колонки H Excel)

**Поля себестоимости:**
- `cost` — себестоимость в рублях (из колонки N Excel, опционально)

**Опциональные поля:**
- `overrideName` — название для отображения (если отличается от каталога)
- `sample: true` — пометить как образец
- `quantityOverride: 1` — переопределить количество
- `note: "текст"` — примечание
- `paidPreviously: true` — оплачено ранее (не входит в сумму)
- `noPayment: true` — без оплаты (например, вернулось с ремонта)

### Новая поставка

Добавьте объект в начало массива `data/shipments.json`:
```json
{
  "id": "shipment-13",
  "title": "Поставка №13",
  "status": "inProgress",
  "eta": "Ожидаем через 2 недели",
  "year": 2025,
  "rawItems": [...]
}
```

**Поля поставки:**
- `id` — уникальный идентификатор (обязательно)
- `title` — название поставки (обязательно)
- `status` — статус поставки (обязательно)
- `year` — год поставки (опционально, определяется автоматически из `receivedDate` или текущий год)
- `receivedDate` — дата получения в формате "DD.MM.YYYY" (опционально)
- `eta` — план доставки (опционально, если нет `receivedDate`)
- `rawItems` — массив позиций (обязательно)

**Статусы поставок (как в Excel / JSON):**

Поле `status` в `shipments.json` содержит **ровно тот текст**, который выбран в Excel (выпадающий список):

- `В работе 🧵`
- `Готово, ожидает отправки 🕒`
- `В пути 🚚`
- `Получено, не оплачено 📦`
- `Получено, оплачено ✅`
- `Оплачено частично 🌓` (частичная оплата)

> **Примечание:**  
> - Никаких enum'ов для статусов поставок в TypeScript больше нет — используется простая строка.  
> - Логика «оплачен / не оплачен» определяется функцией `isPaidStatus(status)` из `lib/statusText.ts`:  
>   - если статус содержит «не оплачен» или одновременно «оплач» и «част» → **НЕ оплачен** и участвует в разделе «Надвигающаяся расплата»;  
>   - если статус содержит «оплачен» и не подпадает под правила частичной оплаты → **оплачен** и не попадает в «расплату»;  
>   - во всех остальных случаях (нет слова «оплач») считается **не оплаченным**.

---

## 🎨 Стилизация

Все цвета, отступы и типографика определены в `constants/styles.ts`:

```typescript
// Основные цвета
COLORS.primary      // #fbbf24 — золотой (акцент)
COLORS.success      // #34d399 — зелёный (оплачено)
COLORS.error        // #f87171 — красный (к оплате)

// Фоны
COLORS.background.dark    // #0a0a0a
COLORS.background.card    // rgba(38,38,38,0.6)

// Отступы
SPACING.xs  // 4px
SPACING.sm  // 8px
SPACING.md  // 16px
SPACING.lg  // 24px
SPACING.xl  // 32px
```

Hover-эффекты для карточек определены в `CARD_HOVER_EFFECTS` и применяются через `createCardHoverHandlers()`.

---

## 🛠 Скрипты

### Node.js скрипты

| Команда | Описание |
|---------|----------|
| `npm run dev` | Запуск в режиме разработки |
| `npm run build` | Сборка для продакшена |
| `npm run start` | Запуск собранного приложения |
| `npm run lint` | Проверка ESLint |
| `npm run typecheck` | Проверка TypeScript |
| `npm run build:full` | Lint + TypeCheck + Build |

### Python скрипты

#### Оптимизация изображений (папка `scripts/`)

| Команда | Описание |
|---------|----------|
| `python scripts/convert_to_webp.py` | Конвертация всех JPG в WebP (пропускает уже существующие) |

**Требования:**
- Python 3.x
- Установленная библиотека: `pip install Pillow`

**Как использовать:**
1. Убедитесь, что все JPG файлы находятся в `public/images/products/jpg/`
2. Запустите скрипт — он создаст WebP версии в `public/images/products/webp/`
3. При повторном запуске скрипт пропустит уже существующие WebP файлы

#### Парсинг Excel (папка `Excel/`)

| Команда | Описание |
|---------|----------|
| `python Excel/parse_excel.py` | Парсинг Excel файла в `data/shipments.json` |
| `python Excel/update_prices.py` | Обновление цен в `data/products.json` из поставок |

---

## 🖼 Оптимизация изображений

Приложение использует оптимизированные WebP изображения для ускорения загрузки.

### Структура папок

```
public/images/products/
├── jpg/          # Оригинальные JPG файлы
│   ├── Жакет из кожи Hermes — mouse.jpg
│   └── ...
└── webp/         # Оптимизированные WebP файлы (автоматически используются)
    ├── Жакет из кожи Hermes — mouse.webp
    └── ...
```

### Как это работает

1. **Пути в `products.json`** указывают на JPG: `/images/products/jpg/фото.jpg`
2. **Утилита `lib/imageUtils.ts`** автоматически преобразует путь в WebP: `/images/products/webp/фото.webp`
3. **Next.js Image** использует WebP версию с `unoptimized={true}` (готовые файлы, без повторной оптимизации)
4. **Blur placeholder** показывается во время загрузки для улучшения воспринимаемой скорости
5. **Fallback на JPG** — если WebP не найден, автоматически переключается на JPG версию (отказоустойчивость)
6. **Обрезка изображений** — в каталоге и меню используется `objectFit: "cover"` с `objectPosition: "top center"` для заполнения контейнера с сохранением пропорций (обрезка только снизу). В детальном просмотре на всех устройствах используется `contain` для показа изображения полностью без обрезки, на мобильных контейнер имеет динамическую высоту на основе `aspect-ratio`

### Преимущества

- **Экономия трафика:** WebP на 25-35% меньше JPG при том же качестве
- **Быстрая загрузка:** готовые оптимизированные файлы без обработки на лету
- **Плавная загрузка:** blur placeholder улучшает UX
- **Автоматический выбор:** компоненты автоматически используют WebP версии
- **Отказоустойчивость:** автоматический fallback на JPG, если WebP не найден (например, забыли запустить скрипт конвертации)

### Добавление новых изображений

1. Поместите JPG файл в `public/images/products/jpg/`
2. Укажите путь в `products.json`: `/images/products/jpg/название.jpg`
3. Запустите `python scripts/convert_to_webp.py` для создания WebP версии
4. Компоненты автоматически будут использовать WebP версию

**Важно:** Если вы забыли запустить скрипт конвертации, изображение всё равно отобразится через JPG fallback. Это обеспечивает отказоустойчивость системы.

### Fallback механизм

При загрузке изображения происходит следующее:

1. **Попытка загрузить WebP** (оптимизированная версия)
2. **Если WebP не найден** → автоматическое переключение на JPG
3. **Если JPG тоже не найден** → показывается эмодзи 📷

Это гарантирует, что пользователь всегда увидит изображение, даже если WebP версия ещё не создана.

**Safety Net:** Если скрипт конвертации `convert_to_webp.py` не был запущен, приложение не сломается. Компонент `<Image />` автоматически переключится на исходный JPG файл через обработчик `onError`. Это гарантирует, что пользователь всегда увидит изображение, даже если WebP версия ещё не создана.

### Выравнивание и обрезка изображений

**Принцип работы:**
- **Каталог (ProductCard) и Меню (Menu):** используется `objectFit: "cover"` с `objectPosition: "top center"` — изображение заполняет контейнер, сохраняя пропорции. Обрезка происходит только снизу, верхняя часть всегда видна полностью.
- **Детальный просмотр (ProductDetail):**
  - **На мобильных устройствах:** используется `objectFit: "contain"` — изображение показывается полностью без обрезки. Контейнер имеет динамическую высоту на основе CSS `aspect-ratio`, ширина 100%.
  - **На десктопе:** используется `objectFit: "contain"` — изображение показывается полностью без обрезки, адаптируясь под размеры контейнера с сохранением пропорций.

**Размеры контейнеров:**
- **Каталог (ProductCard):** высота контейнера 340px
- **Детальный просмотр (ProductDetail):** 
  - Мобильные: 
    - Динамическая высота на основе CSS `aspect-ratio` (вычисляется автоматически из пропорций изображения)
    - Ширина 100%
    - Все контейнеры (включая внутренний) растягиваются на всю ширину экрана для отсутствия боковых рамок
    - Изображение не обрезается, показывается полностью
  - Десктоп: адаптивные размеры на основе aspect-ratio изображения
    - Максимальная ширина: 650px
    - Максимальная высота: 450px
    - Минимальная ширина: 300px
    - Минимальная высота: 300px
    - Внутренний контейнер имеет `width: "auto"` для центрирования контента
    - Отступы: боковые и нижние — 24px (SPACING.lg), верхний — 16px (SPACING.md)
  - Размеры вычисляются автоматически с сохранением пропорций изображения
- **Меню (Menu):** высота определяется стилями меню

Это обеспечивает оптимальное отображение изображений: в каталоге и меню важная верхняя часть всегда видна, а в детальном просмотре изображение показывается полностью без обрезки на всех устройствах.

**Информация на странице товара (ProductDetail):**
- Размеры — доступные размеры товара
- Цена — цена в долларах (обновляется из последней поставки)
- Материалы — верхний материал и подкладка
- Последняя себестоимость — себестоимость в рублях (обновляется из последней поставки, округляется до целых)

---

## 📦 Технологии

### Frontend
- **Next.js 14** — App Router, Server Components, Image Optimization
- **React 18** — UI библиотека
- **TypeScript** — строгая типизация
- **CSS-in-JS** — инлайн-стили с константами

### Backend/Утилиты
- **Python 3.x** — парсинг Excel файлов, оптимизация изображений
- **pandas** — обработка табличных данных
- **openpyxl** — чтение Excel файлов
- **Pillow (PIL)** — конвертация изображений в WebP

Без внешних UI-библиотек — все компоненты написаны с нуля.

---

## 📐 Схема логики проекта

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                    СХЕМА ЛОГИКИ ПРОЕКТА MEHMET METRICS                        ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                          1. ИСТОЧНИКИ ДАННЫХ                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐
    │ products.json    │      │ shipments.json   │      │ money.json       │
    │                  │      │                  │      │                  │
    │ • Каталог товаров│      │ • Поставки        │      │ • Депозиты       │
    │ • Цены (обновл.) │      │ • Позиции         │      │ • Предоплаты     │
    │ • Фото (jpg/webp)│      │ • Историч. цены  │      │                  │
    └────────┬─────────┘      └────────┬──────────┘      └────────┬──────────┘
             │                        │                          │
             │                        │                          │
             ▼                        ▼                          ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │                   2. ПРЕОБРАЗОВАНИЕ ДАННЫХ                          │
    └─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │ lib/adapters.ts                                                     │
    │                                                                     │
    │  toPosition(item, products)                                          │
    │    ├─ Находит product по productId                                  │
    │    ├─ Преобразует sizes: {"xs": 5} → Record<Size, number>         │
    │    ├─ Вычисляет qty (сумма sizes или quantityOverride)            │
    │    ├─ Определяет status из item.status                             │
    │    ├─ Преобразует price (доллары) и cost (рубли) из item          │
    │    ├─ Вычисляет sum = price × qty (если не paidPreviously)        │
    │    └─ Очищает название от размеров в скобках                       │
    │                                                                     │
    │  toBatch(shipment, products)                                       │
    │    ├─ Преобразует rawItems → Position[] через toPosition()        │
    │    ├─ Группирует позиции по статусам (через derive.ts)            │
    │    ├─ Вычисляет totalAmount (сумма всех position.sum)             │
    │    └─ Определяет hasPriceGaps (есть ли позиции без цены)           │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ lib/shipments.ts                                                     │
    │                                                                     │
    │  buildShipments(products)                                           │
    │    ├─ Читает shipments.json                                         │
    │    ├─ Для каждой поставки вызывает toBatch()                      │
    │    └─ Возвращает ShipmentWithItems[]                                │
    │                                                                     │
    │  getShipmentYear(shipment)                                         │
    │    ├─ Если есть явный year → возвращает его                       │
    │    ├─ Если есть receivedDate → извлекает год                       │
    │    └─ Иначе → текущий год                                          │
    │                                                                     │
    │  groupShipmentsByYear(shipments)                                   │
    │    ├─ Группирует поставки по годам                                │
    │    └─ Сортирует годы по убыванию (новые сверху)                    │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ update_prices.py (автоматически вызывается из parse_excel.py)      │
    │                                                                     │
    │  Обновление цен в products.json                                    │
    │    ├─ Проходит по поставкам от новых к старым                     │
    │    ├─ Для каждого productId записывает первую встреченную цену    │
    │    └─ Сохраняет в products.json                                    │
    └─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          3. СТРАНИЦЫ ПРИЛОЖЕНИЯ                             │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │ app/work/page.tsx                                                    │
    │                                                                     │
    │  WorkPage                                                          │
    │    ├─ Загружает products.json                                      │
    │    ├─ Вызывает buildShipments() → ShipmentWithItems[]              │
    │    ├─ Вызывает groupShipmentsByYear() → Map<year, shipments[]>    │
    │    ├─ Управляет состоянием: expandedCards, expandedYears          │
    │    ├─ Сохраняет состояние в sessionStorage                        │
    │    └─ Рендерит Work → YearGroup → BatchView → PositionRow          │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ app/money/page.tsx                                                   │
    │                                                                     │
    │  MoneyPage                                                          │
    │    ├─ Загружает shipments.json и money.json                        │
    │    ├─ Вызывает buildShipments() → ShipmentWithItems[]              │
    │    ├─ Фильтрует поставки: статус НЕ содержит "оплач"               │
    │    ├─ Вычисляет pendingAmount для каждой поставки                   │
    │    └─ Рендерит Money с карточками сумм к оплате                      │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ app/catalog/page.tsx                                                 │
    │                                                                     │
    │  CatalogPage                                                        │
    │    ├─ Загружает products.json (цены уже обновлены скриптом)        │
    │    ├─ Фильтрует товары по категории и inStock                      │
    │    ├─ Сортирует товары по алфавиту (localeCompare)                 │
    │    └─ Рендерит Catalog → ProductCard → ProductDetail                │
    └─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    4. ОПТИМИЗАЦИЯ ИЗОБРАЖЕНИЙ                               │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │ Структура файлов                                                     │
    │                                                                     │
    │  public/images/products/                                            │
    │    ├── jpg/          ← Оригинальные JPG файлы                      │
    │    └── webp/         ← Оптимизированные WebP (скрипт создаёт)      │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ lib/imageUtils.ts                                                    │
    │                                                                     │
    │  getOptimizedImagePath(jpgPath)                                    │
    │    "/images/products/jpg/фото.jpg"                                │
    │    → "/images/products/webp/фото.webp"                              │
    │                                                                     │
    │  getJpgFallbackPath(webpPath)                                      │
    │    "/images/products/webp/фото.webp"                              │
    │    → "/images/products/jpg/фото.jpg"  (fallback)                    │
    │                                                                     │
    │  getBlurPlaceholder()                                              │
    │    → Возвращает base64 SVG для blur эффекта                        │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ Компоненты (ProductCard, ProductDetail, Menu)                        │
    │                                                                     │
    │  <Image                                                             │
    │    src={imageSrc}  ← Начинает с WebP пути                          │
    │    placeholder="blur"                                                │
    │    blurDataURL={getBlurPlaceholder()}                               │
    │    unoptimized={true}  ← Используем готовые WebP                   │
    │    onError={() => {                                                 │
    │      if (imageSrc.includes('/webp/')) {                            │
    │        // Fallback: WebP не найден → переключаемся на JPG          │
    │        setImageSrc(getJpgFallbackPath(imageSrc));                 │
    │      } else {                                                       │
    │        // И JPG не найден → показываем эмодзи 📷                    │
    │        setImageError(true);                                         │
    │      }                                                              │
    │    }}                                                               │
    │  />                                                                 │
    │                                                                     │
    │  Логика fallback:                                                   │
    │    1. Пытается загрузить WebP (оптимизированная версия)            │
    │    2. Если WebP не найден → автоматически переключается на JPG     │
    │    3. Если JPG тоже не найден → показывается эмодзи 📷               │
    │                                                                     │
    │  Преимущество:                                                      │
    │    Если забыли запустить скрипт конвертации, изображение всё равно  │
    │    отобразится через JPG fallback (отказоустойчивость)              │
    └─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    5. ИМПОРТ ДАННЫХ ИЗ EXCEL                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │ Excel/parse_excel.py                                                  │
    │                                                                     │
    │  ExcelParser.parse()                                                │
    │    ├─ Читает Excel лист "Поставки"                                 │
    │    ├─ Определяет разделители годов (2024, 2025)                    │
    │    ├─ Группирует строки по поставкам (№ Поставки + Наименование)  │
    │    ├─ Парсит позиции: название, размеры, цены, статусы             │
    │    ├─ price: из колонки H (Стоймость 1 ед $) — доллары            │
    │    ├─ cost: из колонки N (Себестоимость с учётом карго) — рубли  │
    │    ├─ Обрабатывает колонку P (receivedDate/eta)                    │
    │    ├─ Определяет groupByPayment (все без цены?)                    │
    │    └─ Сохраняет в shipments.json (сортировка: год↓, номер↓)       │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ Excel/update_prices.py                                                │
    │                                                                     │
    │  update_prices_from_shipments()                                    │
    │    ├─ Читает shipments.json (уже отсортированы от новых к старым)│
    │    ├─ Проходит по всем позициям                                    │
    │    ├─ Для каждого productId записывает первую встреченную цену    │
    │    └─ Обновляет products.json (поле price)                          │
    └─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    6. АДАПТИВНОСТЬ И БРЕЙКПОИНТЫ                            │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │ components/providers/BreakpointProvider.tsx                         │
    │                                                                     │
    │  Определяет брейкпоинт по window.innerWidth:                       │
    │    • mobile   < 768px                                              │
    │    • tablet   768-1024px                                           │
    │    • laptop   1024-1280px                                          │
    │    • desktop  ≥ 1280px                                             │
    │                                                                     │
    │  Использует throttle для resize событий (100ms)                    │
    └─────────────────────────────────────────────────────────────────────┘
             │
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │ Компоненты используют useBreakpoint()                              │
    │                                                                     │
    │  const { isMobile, isDesktop, breakpoint } = useBreakpoint();      │
    │                                                                     │
    │  • Адаптивная типографика (размеры шрифтов)                        │
    │  • Адаптивные отступы (SPACING)                                    │
    │  • Адаптивные grid layouts                                        │
    └─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    7. ПОТОК ДАННЫХ (ПРИМЕР)                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    shipments.json
         │
         │ { "id": "shipment-12", "rawItems": [...] }
         ▼
    buildShipments(products)
         │
         │ ShipmentWithItems[]
         │   ├─ id: "shipment-12"
         │   ├─ positions: Position[]
         │   └─ totalAmount: 5500
         ▼
    groupShipmentsByYear(shipments)
         │
         │ Map<2025, [shipment-12, shipment-11, ...]>
         │ Map<2024, [shipment-10, ...]>
         ▼
    WorkPage → YearGroup → BatchView → PositionRow
         │
         │ UI отображение с группировкой по годам
         ▼
    Пользователь видит:
         • ▶ 2025 (открыт)
             • Поставка №12
             • Поставка №11
         • ▶ 2024 (закрыт)

┌─────────────────────────────────────────────────────────────────────────────┐
│                    8. ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ                        │
└─────────────────────────────────────────────────────────────────────────────┘

    • useMemo() для вычислений (shipmentsByYear, categoryProducts)
    • useCallback() для функций (toggleCard, toggleYear)
    • throttle() для resize событий (100ms)
    • sessionStorage для сохранения состояния (expandedCards, expandedYears)
    • WebP изображения с unoptimized={true} (готовые файлы)
    • Blur placeholder для улучшения UX
    • Lazy loading для изображений в каталоге
    • Fallback на JPG при ошибке загрузки WebP (отказоустойчивость)

┌─────────────────────────────────────────────────────────────────────────────┐
│                    9. КЛЮЧЕВЫЕ ФУНКЦИИ И ИХ РОЛЬ                           │
└─────────────────────────────────────────────────────────────────────────────┘

    lib/adapters.ts:
      • toPosition()     → Преобразует сырой item в Position
      • toBatch()        → Собирает Batch из позиций с группировкой

    lib/shipments.ts:
      • buildShipments() → Создаёт ShipmentWithItems[] из JSON
      • getShipmentYear() → Определяет год поставки
      • groupShipmentsByYear() → Группирует по годам

    update_prices.py:
      • Обновляет цены в products.json из shipments.json
      • Автоматически вызывается из parse_excel.py

    lib/imageUtils.ts:
      • getOptimizedImagePath() → JPG путь → WebP путь
      • getJpgFallbackPath() → WebP путь → JPG путь (fallback)
      • getBlurPlaceholder() → Base64 placeholder для blur эффекта

    lib/derive.ts:
      • groupByStatus()  → Группирует позиции по статусам

    lib/format.ts:
      • formatCurrency() → Форматирование валюты в долларах ($1,234)
      • formatCurrencyRUB() → Форматирование валюты в рублях (1 234 ₽, округляет до целых)
      • getStatusIcon()  → Иконка для статуса

╔══════════════════════════════════════════════════════════════════════════════╗
║                          КОНЕЦ СХЕМЫ                                         ║
╚══════════════════════════════════════════════════════════════════════════════╝
```
